# Task: Add Line Numbers to Exported Participant Tables
**Created**: 2025-01-26 | **Status**: In Progress | **Started**: 2025-01-26 14:30:00

## Tracking & Progress
### Linear Issue
- **ID**: AGB-72
- **URL**: https://linear.app/alexandrbasis/issue/AGB-72/add-line-numbers-to-exported-participant-tables

### PR Details
- **Branch**: feature/agb-72-line-numbers-export
- **PR URL**: [Will be added during implementation]
- **Status**: [Draft/Review/Merged]

## Business Requirements
**Status**: ✅ Approved | **Approved by**: User | **Date**: 2025-01-26

### Business Context
Enable quick participant counting and easy reference by adding line numbers as the first column in all exported tables.

### Primary Objective
Add line numbers as the first column in all exported participant tables to improve usability for event organizers who need to quickly see total counts and reference specific participants.

### Use Cases
1. **Quick Participant Counting**: Event organizers can immediately see the total number of participants in any exported list without manually counting rows
   - **Acceptance Criteria**: Line numbers must be sequential, starting from 1, and clearly visible as the first column

2. **Participant Reference by Number**: Staff can reference participants by line number during meetings or discussions (e.g., "participant #15 needs follow-up")
   - **Acceptance Criteria**: Line numbers must remain consistent throughout the export and be easily distinguishable from other data

3. **Export Format Consistency**: All export formats (CSV, text-based lists) should include line numbers for uniform experience
   - **Acceptance Criteria**: Line numbers must be present in all export types generated by the bot

### Success Metrics
- [ ] Line numbers appear as the first column in 100% of exported tables
- [ ] Users can immediately identify the total count by looking at the last line number
- [ ] Line numbers improve participant reference efficiency during team discussions

### Constraints
- Must maintain existing export functionality and not break current integrations
- Line numbers should not interfere with data import into spreadsheet applications
- Implementation must be backward compatible with existing conversation flows

## Test Plan
**Status**: ✅ Approved | **Approved by**: User | **Date**: 2025-01-26

### Test Coverage Strategy
Target: 90%+ coverage across all export functionality with line number implementation

### Test Categories

#### Business Logic Tests
- [ ] **test_line_number_generation**: Verify line numbers start at 1 and increment sequentially
- [ ] **test_line_number_formatting**: Ensure line numbers are properly formatted (right-aligned, consistent width)
- [ ] **test_empty_list_handling**: Verify behavior when exporting empty participant lists
- [ ] **test_large_list_numbering**: Test line numbering with lists > 100 participants (3-digit numbers)

#### Export Format Tests
- [ ] **test_csv_export_with_line_numbers**: Verify CSV exports include line numbers as first column
- [ ] **test_text_export_with_line_numbers**: Verify text-based exports include line numbers
- [ ] **test_markdown_table_with_line_numbers**: Verify markdown table exports include line numbers
- [ ] **test_excel_compatibility**: Ensure line numbers don't break Excel import functionality

#### Data Integrity Tests
- [ ] **test_participant_data_preservation**: Verify adding line numbers doesn't alter participant data
- [ ] **test_column_order_consistency**: Ensure line numbers always appear as first column
- [ ] **test_unicode_handling**: Verify line numbers work with Russian/English mixed content
- [ ] **test_special_characters_in_export**: Ensure line numbers don't interfere with special characters

#### Error Handling Tests
- [ ] **test_export_failure_recovery**: Verify graceful handling if export generation fails
- [ ] **test_memory_efficient_numbering**: Ensure line numbering doesn't cause memory issues with large lists
- [ ] **test_concurrent_export_handling**: Verify line numbers remain consistent with concurrent exports

#### Integration Tests
- [ ] **test_search_to_export_flow**: End-to-end test from search to numbered export
- [ ] **test_list_command_export_flow**: Test /list command with line numbers in export
- [ ] **test_multiple_export_formats**: Verify user can choose format and all include line numbers
- [ ] **test_telegram_file_size_limits**: Ensure line numbers don't cause file size issues

#### User Interaction Tests
- [ ] **test_export_command_response**: Verify export commands show total count based on line numbers
- [ ] **test_export_preview_formatting**: Ensure preview messages show line numbers correctly
- [ ] **test_export_success_message**: Verify success message includes total participant count

### Test-to-Requirement Mapping
- **Quick Participant Counting** → Tests: test_line_number_generation, test_large_list_numbering, test_export_command_response
- **Participant Reference by Number** → Tests: test_line_number_formatting, test_column_order_consistency, test_search_to_export_flow
- **Export Format Consistency** → Tests: test_csv_export_with_line_numbers, test_text_export_with_line_numbers, test_markdown_table_with_line_numbers, test_multiple_export_formats

## Technical Requirements
**Status**: ✅ Plan Reviewed | **Reviewed by**: Plan Reviewer Agent | **Date**: 2025-01-26

### Technical Requirements
- [ ] Add line number generation logic to all export service CSV methods
- [ ] Ensure line numbers are the first column in all CSV outputs
- [ ] Maintain proper formatting for line numbers (right-aligned, consistent width)
- [ ] Preserve all existing CSV functionality and data integrity
- [ ] Update all export service classes (ParticipantExportService, BibleReadersExportService, RoeExportService)
- [ ] Ensure line numbers work correctly with filtered exports (by role, department, etc.)

### Implementation Steps & Change Log

- [ ] Step 1: Create line number utility function
  - [ ] Sub-step 1.1: Add line number formatting utility
    - **Directory**: `src/utils/`
    - **Files to create/modify**: `src/utils/export_utils.py`
    - **Accept**: Utility function that generates formatted line numbers
    - **Tests**: `tests/unit/test_utils/test_export_utils.py`
    - **Done**: Function can generate line numbers with proper formatting
    - **Changelog**: Created export_utils.py with format_line_number() and add_line_numbers_to_csv() functions

- [ ] Step 2: Update ParticipantExportService
  - [ ] Sub-step 2.1: Modify CSV header generation
    - **Directory**: `src/services/`
    - **Files to create/modify**: `src/services/participant_export_service.py`
    - **Accept**: Headers include "#" or "№" as first column
    - **Tests**: Update `tests/unit/test_services/test_participant_export_service.py`
    - **Done**: _get_csv_headers() returns line number column first
    - **Changelog**: Modified _get_csv_headers() to prepend line number column

  - [ ] Sub-step 2.2: Add line numbers to CSV row generation
    - **Directory**: `src/services/`
    - **Files to create/modify**: `src/services/participant_export_service.py`
    - **Accept**: Each row includes sequential line number as first value
    - **Tests**: Update `tests/unit/test_services/test_participant_export_service.py`
    - **Done**: CSV output shows line numbers in first column
    - **Changelog**: Modified get_all_participants_as_csv(), get_participants_by_role_as_csv(), get_participants_by_department_as_csv(), and _records_to_csv() to add line numbers

  - [ ] Sub-step 2.3: Update view-based export methods
    - **Directory**: `src/services/`
    - **Files to create/modify**: `src/services/participant_export_service.py`
    - **Accept**: View exports include line numbers
    - **Tests**: Update `tests/unit/test_services/test_participant_export_service.py`
    - **Done**: _export_view_to_csv() and _records_to_csv() include line numbers
    - **Changelog**: Modified _determine_view_headers() and _records_to_csv() to handle line numbering

- [ ] Step 3: Update BibleReadersExportService
  - [ ] Sub-step 3.1: Modify CSV generation for Bible readers
    - **Directory**: `src/services/`
    - **Files to create/modify**: `src/services/bible_readers_export_service.py`
    - **Accept**: Bible readers export includes line numbers
    - **Tests**: Update `tests/unit/test_services/test_bible_readers_export_service.py`
    - **Done**: Bible readers CSV has line numbers as first column
    - **Changelog**: Modified _get_csv_headers() and get_all_bible_readers_as_csv() to add line numbers

- [ ] Step 4: Update RoeExportService
  - [ ] Sub-step 4.1: Modify CSV generation for ROE
    - **Directory**: `src/services/`
    - **Files to create/modify**: `src/services/roe_export_service.py`
    - **Accept**: ROE export includes line numbers
    - **Tests**: Update `tests/unit/test_services/test_roe_export_service.py`
    - **Done**: ROE CSV has line numbers as first column
    - **Changelog**: Modified _get_csv_headers() and get_all_roe_as_csv() to add line numbers

- [ ] Step 5: Update export message formatting
  - [ ] Sub-step 5.1: Include total count in export success messages
    - **Directory**: `src/bot/handlers/`
    - **Files to create/modify**: `src/bot/handlers/export_handlers.py`, `src/bot/handlers/export_conversation_handlers.py`
    - **Accept**: Success messages show total participant count
    - **Tests**: Update `tests/unit/test_bot_handlers/test_export_handlers.py`
    - **Done**: Export completion messages display total count
    - **Changelog**: Modified handle_export_command() and export conversation handlers to show participant count in success messages

- [ ] Step 6: Integration testing
  - [ ] Sub-step 6.1: Test end-to-end export flows
    - **Directory**: `tests/integration/`
    - **Files to create/modify**: `tests/integration/test_export_command_integration.py`, `tests/integration/test_export_selection_workflow.py`
    - **Accept**: All export paths produce CSV files with line numbers
    - **Tests**: Run existing integration tests with line number validation
    - **Done**: Integration tests pass with line numbers in all exports
    - **Changelog**: Updated integration tests to verify line number presence and formatting

### Task Splitting Evaluation
**Status**: ✅ Evaluated | **Evaluated by**: Task Splitter Agent | **Date**: 2025-01-26
**Decision**: No Split Needed
**Reasoning**: Single cohesive feature with consistent pattern across services, appropriate PR size (~200-300 lines), strong dependencies between steps, and atomic user value requiring all export types to have line numbers