# Bot Commands Reference

## Search Commands

### /search [query] and Search Button
Search for participants by name (Russian or English), nickname, or other details. Available via command or main menu "üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" button.

**Main Menu Button Equivalence** (Enhanced 2025-09-09):
- Main Menu button provides identical functionality to `/start` command
- **Shared Initialization**: Both use `initialize_main_menu_session()` and `get_welcome_message()` helpers
- **Consistent Welcome**: Same Russian message: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç Tres Dias! üôè\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."
- **Entry Point Recovery**: Text button handlers enable conversation re-entry after timeout without manual `/start`

### /search_room [room_number]
Search for participants assigned to a specific room number with enhanced structured Russian results. Supports alphanumeric room identifiers.

**Usage Examples:**
- `/search_room 205` - Find participants in room 205
- `/search_room A1` - Find participants in room A1
- `/search_room Conference` - Find participants in Conference room

**Enhanced Features (2025-01-09):**
- **Structured Russian Results**: Displays participant information with role, department, and floor translations
- **Complete Translation Support**: All departments and roles displayed in Russian using comprehensive translation mappings
- **Rich Formatting**: Shows participant names (Russian/English), translated role/department, and floor context
- **Input Validation**: Validates room number format with user-friendly Russian error messages
- **Russian Interface**: Complete Russian language support throughout the interaction
- **Empty Room Handling**: Shows appropriate message when room is empty
- **Navigation**: Reply keyboard for easy mode switching between search types

**Example Structured Output:**
```
üè† –ö–æ–º–Ω–∞—Ç–∞ 205:

üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤)
   –†–æ–ª—å: –ö–∞–Ω–¥–∏–¥–∞—Ç
   –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: ROE
   –≠—Ç–∞–∂: 2

üë§ –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (Maria Ivanova)  
   –†–æ–ª—å: –ö–æ–º–∞–Ω–¥–∞
   –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: –ö—É—Ö–Ω—è
   –≠—Ç–∞–∂: 2
```

### /search_floor [floor_number]
Search for participants on a specific floor with room-by-room breakdown. Features interactive floor discovery for enhanced user experience.

**Usage Examples:**
- `/search_floor 2` - Find all participants on floor 2
- `/search_floor 1` - Find all participants on floor 1
- `/search_floor Ground` - Find participants on ground floor

**Enhanced Interactive Features (2025-01-21):**
- **Interactive Floor Discovery**: "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —ç—Ç–∞–∂–∏" button reveals available floors without guessing
- **Floor Selection Buttons**: Available floors display as clickable "–≠—Ç–∞–∂ 1", "–≠—Ç–∞–∂ 2" buttons for direct selection
- **Dual Input Methods**: Users can discover floors via button or manually enter floor numbers
- **Enhanced Guidance**: Clear instructions show both button interaction and manual input options in Russian
- **Error Fallback**: If discovery fails, users get manual input guidance: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–∏—à–ª–∏—Ç–µ –Ω–æ–º–µ—Ä —ç—Ç–∞–∂–∞ —Ü–∏—Ñ—Ä–æ–π."

**Core Features:**
- **Room Grouping**: Results organized by room with participant counts
- **Smart Sorting**: Numeric rooms sorted numerically, then alphabetically
- **Floor Overview**: Shows total participant count and room distribution
- **Russian Interface**: Complete Russian language support with localized messages
- **Empty Floor Handling**: Shows appropriate message when floor is empty
- **Navigation**: Reply keyboard for search mode selection

**Button Functionality**: The search button uses ConversationHandler with proper state management (SearchStates: 10-12) and per_message configuration to ensure reliable button response.

**Interactive Floor Discovery Workflow (2025-01-21):**
1. User clicks "üè¢ –ü–æ —ç—Ç–∞–∂—É" from search mode selection
2. Bot displays enhanced prompt: "–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–∏—à–ª–∏—Ç–µ –Ω–æ–º–µ—Ä —ç—Ç–∞–∂–∞ —Ü–∏—Ñ—Ä–æ–π:" with "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —ç—Ç–∞–∂–∏" button
3. **Interactive Discovery Path**: User clicks discovery button ‚Üí Bot shows available floors as "–≠—Ç–∞–∂ 1", "–≠—Ç–∞–∂ 2" buttons (3 per row)
4. **Direct Selection**: User clicks floor button ‚Üí Bot triggers floor search automatically
5. **Manual Input Path**: User types floor number ‚Üí Bot processes search as before
6. **Error Recovery**: API failures show helpful fallback message with manual input guidance

## Get List Commands

### Get List Button and Bulk Access
Access pre-filtered participant lists by role for quick bulk viewing. Available via main menu "üìã –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫" button alongside the search functionality.

**Main Menu Integration**: The Get List button provides instant access to categorized participant lists without requiring search queries, ideal for administrative tasks and logistics planning.

**Usage Flow:**
1. User clicks "üìã –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫" from main menu
2. Bot displays role selection: "üë• –ö–æ–º–∞–Ω–¥–∞" (Team) or "üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã" (Candidates)
3. User selects desired role
4. Bot displays paginated numbered list with all participants in that role
5. Navigation with "‚óÄÔ∏è –ù–∞–∑–∞–¥", "‚ñ∂Ô∏è –î–∞–ª–µ–µ", and "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" buttons

### Team Members List
View complete list of all team members with comprehensive details for logistics and organization planning.

**Features:**
- **Server-side Role Filtering**: Efficient Airtable filtering by role="TEAM"
- **Numbered List Format**: Sequential numbering (1., 2., 3.) for easy reference
- **Complete Information**: Full name (Russian), clothing size, church, date of birth (DD.MM.YYYY)
- **Pagination**: Dynamic page size with Telegram 4096-character message limit handling
- **Offset-based Navigation**: Ensures no participants are skipped during pagination

**Display Example:**
```
**–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã** (—ç–ª–µ–º–µ–Ω—Ç—ã 1-20 –∏–∑ 45)

1. **–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤**
   üëï –†–∞–∑–º–µ—Ä: M
   ‚õ™ –¶–µ—Ä–∫–æ–≤—å: –•—Ä–∞–º –•—Ä–∏—Å—Ç–∞ –°–ø–∞—Å–∏—Ç–µ–ª—è
   üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: 15.06.1985

2. **–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞**
   üëï –†–∞–∑–º–µ—Ä: S
   ‚õ™ –¶–µ—Ä–∫–æ–≤—å: –¶–µ—Ä–∫–æ–≤—å –°–≤—è—Ç–æ–≥–æ –ù–∏–∫–æ–ª–∞—è
   üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: 22.03.1990

... (continues with remaining participants)
```

### Candidates List
View complete list of all candidates with the same comprehensive formatting as team members.

**Features:**
- **Server-side Role Filtering**: Efficient Airtable filtering by role="CANDIDATE"
- **Identical Format**: Same numbered list format and information display as team list
- **Consistent Navigation**: Same pagination and navigation controls
- **Administrative Focus**: Designed for candidate management and review processes

**Display Example:**
```
**–°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤** (—ç–ª–µ–º–µ–Ω—Ç—ã 1-18 –∏–∑ 32)

1. **–ê–Ω–Ω–∞ –ö–æ–∑–ª–æ–≤–∞**
   üëï –†–∞–∑–º–µ—Ä: L
   ‚õ™ –¶–µ—Ä–∫–æ–≤—å: –¶–µ—Ä–∫–æ–≤—å –ü–æ–∫—Ä–æ–≤–∞
   üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: 08.12.1988

2. **–ü–µ—Ç—Ä –°–º–∏—Ä–Ω–æ–≤**
   üëï –†–∞–∑–º–µ—Ä: XL
   ‚õ™ –¶–µ—Ä–∫–æ–≤—å: –°–æ–±–æ—Ä –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ù–µ–≤—Å–∫–æ–≥–æ
   üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: –ù–µ —É–∫–∞–∑–∞–Ω–æ

... (continues with remaining participants)
```

### Pagination and Navigation
Lists support robust pagination designed to handle large datasets without losing participants.

**Navigation Controls:**
- **"‚óÄÔ∏è –ù–∞–∑–∞–¥" (Previous)**: Navigate to previous page of results
- **"‚ñ∂Ô∏è –î–∞–ª–µ–µ" (Next)**: Navigate to next page of results  
- **"üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" (Main Menu)**: Return to main menu and exit list view

**Technical Features:**
- **Offset-based Pagination**: Prevents participant skipping when content is trimmed for message length limits
- **Dynamic Page Sizing**: Automatically adjusts number of participants per page to stay under 4096 character limit
- **Continuity Guarantee**: Ensures all participants are accessible across pages without gaps or duplicates
- **State Management**: Maintains current position and role context during navigation

### Empty Result Handling
Graceful handling when no participants exist for selected role.

**Empty Team List:**
```
–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
```

**Empty Candidate List:**
```
–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
```

### Use Case Examples

#### Event Logistics Planning
**Scenario**: Event organizer needs clothing sizes for all team members
1. Click "üìã –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫" ‚Üí "üë• –ö–æ–º–∞–Ω–¥–∞"
2. Review complete team list with sizes displayed for each participant
3. Navigate through pages to access all 45+ team members
4. Export or reference information for logistics planning

#### Candidate Review Process  
**Scenario**: Review committee needs complete candidate roster
1. Click "üìã –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫" ‚Üí "üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã"
2. View numbered list of all candidates with church affiliations
3. Use pagination to systematically review all candidates
4. Reference participant numbers for committee discussions

#### Administrative Tasks
**Scenario**: Quick access to specific participant categories without search queries
1. Instant access via main menu button (2-click workflow)
2. No search terms or filters required - complete category view
3. Efficient server-side filtering prevents loading unnecessary data
4. Consistent formatting for easy scanning and reference

**Usage Examples:**
- `/search –ò–≤–∞–Ω` - Find participants with "–ò–≤–∞–Ω" in their name
- `/search John` - Find participants with "John" in their name  
- `/search —Ü–µ—Ä–∫–æ–≤—å` - Find participants by church name

**Enhanced Features:**
- **Language Detection**: Automatically detects Cyrillic vs Latin script
- **Multi-field Search**: Searches Russian names, English names, nicknames, church, location
- **Fuzzy Matching**: Finds similar names even with typos
- **Match Quality Labels**: Shows search confidence (–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –•–æ—Ä–æ—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
- **Interactive Selection**: Click participant buttons to view/edit details
- **Search Mode Selection**: Reply keyboard with buttons for Name/Room/Floor search modes

**Search Results Display:**
- Shows up to 10 participants per page
- Displays: Name (Russian/English), Role, Department, Demographics (Date of Birth, Age), Match Quality
- "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" (Details) button for each participant
- Pagination with "–ù–∞–∑–∞–¥" (Back) and "–î–∞–ª–µ–µ" (Next) buttons
- Enhanced display format includes demographic info: "Date of Birth: YYYY-MM-DD | Age: XX years" (or "N/A" for missing data)

## Participant Editing Interface

### Participant Selection
After searching, click "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" (Details) on any participant to access the comprehensive editing interface.

**Complete Participant Profile Display:**
- Full Name (Russian): [Name]
- Full Name (English): [Name] 
- Church: [Church]
- Country/City: [Location]
- Gender: [–ú/–ñ]
- Size: [XS-3XL]
- Role: [–ö–∞–Ω–¥–∏–¥–∞—Ç/–ö–æ–º–∞–Ω–¥–∞]
- Department: [Department]
- Contact: [Contact Info]
- Payment Status: [–û–ø–ª–∞—á–µ–Ω–æ/–ß–∞—Å—Ç–∏—á–Ω–æ/–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ]
- Payment Amount: [Amount]
- Payment Date: [Date]
- üéÇ Date of Birth: [YYYY-MM-DD or –ù–µ —É–∫–∞–∑–∞–Ω–æ] *Fixed display issue 2025-09-11*
- üî¢ Age: [XX years or –ù–µ —É–∫–∞–∑–∞–Ω–æ] *Fixed display issue 2025-09-11*
- Submitted By: [Name]

### Enhanced Field Editing Display

**Complete Participant Context After Edits**: After successfully updating any field, the bot displays the complete participant profile with all current information, including the newly updated field. This provides users with full context and confirmation of changes without requiring navigation back to search results.

**Display Features**:
- Uses the same rich formatting as initial search results for consistency
- Shows all participant fields in their current state
- Includes the updated field value within the complete profile
- Maintains the same edit buttons for continued editing

### Field Editing Commands

Each participant field can be edited through dedicated "–ò–∑–º–µ–Ω–∏—Ç—å [Field]" buttons:

#### Button-Based Fields (Immediate Selection)

1. **"–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª" (Edit Gender)**
   - Options: "–ú—É–∂—Å–∫–æ–π" (M), "–ñ–µ–Ω—Å–∫–∏–π" (F)
   - Click button ‚Üí Select option ‚Üí Complete participant display with updated information

2. **"–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä" (Edit Size)**  
   - Options: XS, S, M, L, XL, XXL, 3XL
   - Click button ‚Üí Select size ‚Üí Complete participant display with updated information

3. **"–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å" (Edit Role)**
   - Options: "–ö–∞–Ω–¥–∏–¥–∞—Ç" (Candidate), "–ö–æ–º–∞–Ω–¥–∞" (Team)
   - Click button ‚Üí Select role ‚Üí Complete participant display with updated information

4. **"–ò–∑–º–µ–Ω–∏—Ç—å –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç" (Edit Department)**
   - Options: ROE, Chapel, Setup, Palanka, Administration, Kitchen, Decoration, Bell, Refreshment, Worship, Media, Clergy, Rectorate
   - Click button ‚Üí Select department ‚Üí Complete participant display with updated information

5. **"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞" (Edit Payment Status)**
   - Options: "–û–ø–ª–∞—á–µ–Ω–æ" (Paid), "–ß–∞—Å—Ç–∏—á–Ω–æ" (Partial), "–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ" (Unpaid)
   - Click button ‚Üí Select status ‚Üí Complete participant display with updated information

#### Text Input Fields (Prompt Workflow)

1. **"–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è (—Ä—É—Å—Å–∫–æ–µ)" (Edit Russian Name)** ‚≠ê *Required*
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
   - Type new name ‚Üí Validation (required, min length 1) ‚Üí Complete participant display with updated information

2. **"–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è (–∞–Ω–≥–ª–∏–π—Å–∫–æ–µ)" (Edit English Name)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º" 
   - Type new name ‚Üí Complete participant display with updated information

3. **"–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ—Ä–∫–æ–≤—å" (Edit Church)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ—Ä–∫–≤–∏"
   - Type church name ‚Üí Complete participant display with updated information

4. **"–ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" (Edit Location)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥"
   - Type location ‚Üí Complete participant display with updated information

5. **"–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã" (Edit Contact)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"
   - Type contact info ‚Üí Complete participant display with updated information

6. **"–ò–∑–º–µ–Ω–∏—Ç—å –∫—Ç–æ –ø–æ–¥–∞–ª" (Edit Submitted By)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º—è —Ç–æ–≥–æ, –∫—Ç–æ –ø–æ–¥–∞–ª"
   - Type submitter name ‚Üí Complete participant display with updated information

#### Special Validation Fields

1. **"–ò–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É" (Edit Payment Amount)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)"
   - Type amount ‚Üí Validation (integer ‚â• 0) ‚Üí Complete participant display with updated information
   - Error message if invalid: "–û—à–∏–±–∫–∞: –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º"

2. **"–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞" (Edit Payment Date)**
   - Click button ‚Üí Bot prompts: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î"
   - Type date ‚Üí Validation (YYYY-MM-DD format) ‚Üí Complete participant display with updated information
   - Error message if invalid: "–û—à–∏–±–∫–∞: –î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î"

3. **"–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è" (Edit Date of Birth)** üîß *Fixed 2025-09-11*
   - Click button ‚Üí Bot prompts: "üìÖ –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1990-05-15):"
   - Type date ‚Üí Validation (YYYY-MM-DD format) ‚Üí Complete participant display with updated information
   - **Clearing Support**: Send only whitespace to clear field (displays "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
   - **Fixed JSON Serialization**: Resolves "Object of type date is not JSON serializable" error
   - Error message if invalid: "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1990-05-15)" + InfoMessages guidance

4. **"–ò–∑–º–µ–Ω–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç" (Edit Age)** üîß *Fixed 2025-09-11*
   - Click button ‚Üí Bot prompts: "üî¢ –í–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç (–æ—Ç 0 –¥–æ 120):"
   - Type age ‚Üí Validation (0-120 integer range) ‚Üí Complete participant display with updated information
   - **Clearing Support**: Send only whitespace to clear field (displays "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
   - **Fixed Display**: Resolves missing age field in participant reconstruction after editing
   - Error messages if invalid: "‚ùå –í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 120" or "‚ùå –í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º" + InfoMessages guidance

### Save/Cancel Actions

#### Save Confirmation Workflow
- **"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" (Save Changes)**: Displays confirmation screen showing all pending changes
- **Confirmation Screen**: Shows "Current Value ‚Üí **New Value**" format for all modified fields
- **"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ" (Confirm Save)**: Commits all changes to Airtable
- **Save Success**: Displays complete updated participant information using format_participant_result() with all applied changes, providing full context instead of simple confirmation message

#### Cancel and Navigation
- **"–û—Ç–º–µ–Ω–∞" (Cancel)**: Discards all changes and returns to main menu using shared initialization helpers for consistent state reset
- **"–ù–∞–∑–∞–¥ –∫ –ø–æ–∏—Å–∫—É" (Back to Search)**: Returns to search results without saving
- **"–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" (Return to Main Menu)**: Cancel confirmation option

**Enhanced Cancel Handler** (2025-09-09):
- Uses shared `initialize_main_menu_session()` and `get_welcome_message()` for consistent state management
- Provides same unified welcome message as start command and main menu button
- Ensures proper state reset with search_results clearing and force_direct_name_input flag setting

#### Error Handling and Retry
- **Save Failure**: Automatic retry buttons appear on Airtable update errors
- **"–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" (Try Again)**: Retry failed save operation preserving changes
- **Error Messages**: User-friendly Russian error messages with actionable instructions
- **Data Preservation**: User changes maintained during retry operations
- **Display Error Recovery**: Enhanced error handling prevents silent display failures during field editing with comprehensive logging (REGRESSION markers) and meaningful user feedback
- **Context Loss Handling**: Graceful degradation when participant context is lost, providing clear error messages and recovery guidance

## Search Mode Navigation

### Search Mode Selection Interface
Users can switch between different search modes using a reply keyboard interface:

**Available Modes:**
- **"üë§ –ü–æ –∏–º–µ–Ω–∏" (Name Search)**: Traditional participant name search
- **"üö™ –ü–æ –∫–æ–º–Ω–∞—Ç–µ" (Room Search)**: Search by room number  
- **"üè¢ –ü–æ —ç—Ç–∞–∂—É" (Floor Search)**: Search by floor with room breakdown

**Navigation Flow:**
1. User clicks main menu "üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" button
2. Bot displays search mode selection keyboard
3. User selects desired search mode by clicking the appropriate button
4. Bot prompts for appropriate input (name, room number, or floor)
5. Results displayed with option to return to mode selection

**Critical Fix (2025-09-10)**: Search mode buttons now correctly transition to input waiting states instead of being processed as search queries. The buttons "üë§ –ü–æ –∏–º–µ–Ω–∏", "üö™ –ü–æ –∫–æ–º–Ω–∞—Ç–µ", and "üè¢ –ü–æ —ç—Ç–∞–∂—É" properly trigger prompt messages and wait for user input rather than immediately searching for the button text itself.

## Room and Floor Search Results

### Room Search Display
```
üè† –ö–æ–º–Ω–∞—Ç–∞ 205:

üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (–ö–∞–Ω–¥–∏–¥–∞—Ç)
   –¶–µ—Ä–∫–æ–≤—å: –•—Ä–∞–º –•—Ä–∏—Å—Ç–∞ –°–ø–∞—Å–∏—Ç–µ–ª—è
   
üë§ –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (–ö–æ–º–∞–Ω–¥–∞)
   –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: ROE
   
–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞
```

### Floor Search Display
```
üè¢ –≠—Ç–∞–∂ 2:

üè† –ö–æ–º–Ω–∞—Ç–∞ 201 (3 —É—á–∞—Å—Ç–Ω–∏–∫–∞):
   ‚Ä¢ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (–ö–∞–Ω–¥–∏–¥–∞—Ç)
   ‚Ä¢ –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (–ö–æ–º–∞–Ω–¥–∞)
   ‚Ä¢ –°–µ—Ä–≥–µ–π –°–∏–¥–æ—Ä–æ–≤ (–ö–∞–Ω–¥–∏–¥–∞—Ç)

üè† –ö–æ–º–Ω–∞—Ç–∞ 205 (2 —É—á–∞—Å—Ç–Ω–∏–∫–∞):
   ‚Ä¢ –ê–Ω–Ω–∞ –ö–æ–∑–ª–æ–≤–∞ (–ö–æ–º–∞–Ω–¥–∞)
   ‚Ä¢ –ü–µ—Ç—Ä –°–º–∏—Ä–Ω–æ–≤ (–ö–∞–Ω–¥–∏–¥–∞—Ç)

–í—Å–µ–≥–æ –Ω–∞ —ç—Ç–∞–∂–µ: 5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ 2 –∫–æ–º–Ω–∞—Ç–∞—Ö
```

## Conversation Timeout Handling

### Automatic Session Management
All conversations include automatic timeout handling to prevent users from getting stuck in stale states:

- **Timeout Period**: Configurable via `TELEGRAM_CONVERSATION_TIMEOUT_MINUTES` environment variable (default: 30 minutes)
- **Timeout Message**: "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ" (Session expired, start again)
- **Recovery Option**: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" button returns user to main menu
- **State Cleanup**: Automatic conversation context cleanup prevents memory leaks
- **Universal Coverage**: Applied to all conversation types (search, edit, room/floor search)

### Timeout Scenarios
- **Search Conversations**: User searches but doesn't interact with results
- **Edit Workflows**: User enters editing mode but doesn't complete changes
- **Room/Floor Search**: User initiates location search but doesn't provide input
- **Any Conversation State**: Timeout applies to all states equally

### User Recovery Flow
1. User becomes inactive during any conversation
2. After timeout period (default 30 minutes), bot displays timeout message
3. User clicks "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" button
4. User returns to main menu and can start fresh conversation
5. Previous conversation context is completely cleaned up

## Error Handling

### Standardized Error Messages (2025-09-05)
Error handling has been enhanced with centralized message templates located in `src/bot/messages.py` providing consistent, user-friendly Russian error messages across all search functionality.

### Validation Errors
- Clear Russian error messages for invalid input
- Prompts user to retry with correct format
- Field-specific validation rules enforced
- **Room Number Validation**: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 205, A1, Conference)"
- **Floor Number Validation**: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —ç—Ç–∞–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, Ground)"
- **Empty Results**: "–ü–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

### System Errors  
- Graceful handling of Airtable API errors
- Rate limiting protection (5 requests/second)
- Connection timeout recovery with 30-second timeout and 3 retry attempts
- **API Error Messages**: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ" with retry guidance
- Empty room/floor result handling with user-friendly messages

### Integration Testing and Performance
- **Response Time Validation**: All searches validated to complete within 3 seconds
- **Comprehensive Error Scenario Testing**: 28+ integration tests covering API failures, invalid inputs, and edge cases
- **Production Readiness**: Error handling tested against real Airtable field mappings and schema validation

## Usage Flow Examples

### Name Search Flow
1. User types: `/search –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤`
2. Bot shows search results with "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" buttons
3. User clicks "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" on desired participant
4. Bot displays complete participant profile with 13 edit buttons
5. User clicks "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å" (Edit Role)
6. Bot shows role options: "–ö–∞–Ω–¥–∏–¥–∞—Ç", "–ö–æ–º–∞–Ω–¥–∞"
7. User selects "–ö–æ–º–∞–Ω–¥–∞"
8. Bot displays complete participant profile with updated role information
9. User clicks "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" to review changes
10. **Confirmation Screen**: Shows "–†–æ–ª—å: –ö–∞–Ω–¥–∏–¥–∞—Ç ‚Üí **–ö–æ–º–∞–Ω–¥–∞**"
11. User clicks "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ" to commit changes
12. Bot saves to Airtable and confirms: "–£—á–∞—Å—Ç–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
13. User returns to search results with context preserved

### Room Search Flow (Enhanced 2025-01-15)
1. User clicks "üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" in main menu
2. Bot displays search mode selection keyboard
3. User clicks "üè† –ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–Ω–∞—Ç–µ" (Room Search)
4. Bot prompts: "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞:" (single clean prompt)
5. User types: `205` OR clicks "‚ùå –û—Ç–º–µ–Ω–∞" to return to main menu
6. Bot displays room search results with participant list
7. User can click "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" to view/edit participant details
8. Navigation options: return to search mode selection or main menu

**Enhanced User Experience (2025-01-15)**:
- **Single Clean Prompt**: Room search mode sends exactly one message asking for room number
- **Proper Cancel Support**: Cancel button works correctly during room input without validation errors
- **No Duplicate Messages**: Eliminated duplicate prompts that previously confused users
- **Consistent Pattern**: Room search now mirrors floor search behavior for UI consistency

### Floor Search Flow
1. User types: `/search_floor 2`
2. Bot displays floor overview with room-by-room breakdown
3. Results show: room numbers, participant counts, and participant names
4. User can navigate to specific participants for detailed view
5. Navigation options: search other floors or return to main menu

### Error Recovery Flow

1. User attempts to save changes
2. **Airtable Error Occurs** (network/API issue)
3. Bot displays: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Airtable" 
4. **Retry Button**: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" appears automatically
5. User clicks retry ‚Üí Bot attempts save again with preserved changes
6. Success: Changes saved and user notified
7. Failure: Retry option remains available

### Timeout Recovery Flow

1. User starts participant search: `/search –ò–≤–∞–Ω`
2. Bot shows search results with "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" buttons
3. **User becomes inactive** (no interaction for 30 minutes)
4. **Timeout Triggers**: Bot displays "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ"
5. **Recovery Button**: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" button appears
6. User clicks recovery button ‚Üí Returns to main menu with clean state
7. User can start fresh conversation without any residual context
8. **Alternative**: User can also ignore timeout message and use any main menu command
