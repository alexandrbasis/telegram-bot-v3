# Merge PR Command

## PRIMARY OBJECTIVE
Complete the development workflow by merging approved PRs and archiving tasks.IMPORTANT: Think hard

## CONTEXT
Use only when:
- Code review shows "âœ… APPROVED FOR MERGE"
- All issues resolved, tests passing, 
- Important: Ensure that the CI passed
- User explicitly approves merge

## WORKFLOW STEPS

### **STEP 1: Pre-Merge Validation**

1. **Ask**: "Which task/PR to merge? Provide task path or PR URL."

2. **Validate readiness**:
   - Task document exists with "âœ… APPROVED FOR MERGE" status
   - PR referenced in task document
   - Linear issue "Ready to Merge"
   - All review issues resolved

3. **Safety checks**:
   - Get explicit user confirmation
   - Verify branch up to date, CI passing, no conflicts

### **STEP 2: Pre-Merge Updates**

#### **Update Documentation (docs-updater agent)**
1. **Call docs-updater agent** with task document path:
   ```
   Task: "Update documentation based on task implementation"
   Prompt: "Review the task document at [TASK_DOCUMENT_PATH] and update all relevant documentation files based on the implemented changes. Return a summary of what documentation was updated."
   ```

2. **Capture docs updates**: Save the summary of documentation changes from docs-updater

#### **Update Changelog (changelog-generator agent)**
1. **Call changelog-generator agent** with task information:
   ```
   Task: "Generate changelog entry for completed task"
   Prompt: "Generate a changelog entry based on the task document at [TASK_DOCUMENT_PATH] and documentation updates: [DOCS_UPDATES_SUMMARY]. Include the main feature implementation and any documentation changes."

   ```

2. **Capture changelog**: Save the changelog entry for later use

### **STEP 3: Commit Pre-Merge Updates**

#### **Commit Documentation and Changelog Updates**
1. **Stage all changes** made by agents:
   ```bash
   git add .
   ```

2. **Create commit** with updates from both agents:
   ```bash
   git commit -m "docs: Update documentation and changelog

   - Documentation updates: [DOCS_UPDATES_SUMMARY]
   - Changelog entry: [CHANGELOG_SUMMARY]
   
   Updates generated by docs-updater and changelog-generator agents
   before PR merge to preserve all work."
   ```

3. **Push updates** to the task PR branch:
   ```bash
   git push origin [TASK_BRANCH]
   ```

4. **Verify updates** in PR:
   ```bash
   gh pr view [PR]
   ```

### **STEP 4: Merge Execution**

#### **Execute Merge**
1. **Merge PR** with appropriate strategy:
   - Squash: `gh pr merge [PR] --squash` (preferred)
   - Merge: `gh pr merge [PR] --merge`
   - Rebase: `gh pr merge [PR] --rebase`

2. **Capture details**: SHA, timestamp, branches

#### **Verify**
1. **Confirm merge**: `gh pr view [PR]` shows merged
2. **Check target branch**: `git log --oneline -5`
3. **Validate CI**: `gh pr checks [PR]` pass
4. **Test critical paths** if specified

### **STEP 5: Documentation**

1. **Update task status** to "Completed" with timestamp

2. **Complete PR Traceability**:
   ```markdown
   ## PR Traceability
   - **PR ID/URL**: [PR details]
   - **Branch**: [merged branch]
   - **Status**: âœ… APPROVED â†’ âœ… MERGED
   - **SHA**: [commit hash]
   - **Date**: [timestamp]
   ```

3. **Add completion summary**:
   ```markdown
   ## Task Completion
   **Date**: [timestamp]
   **Status**: âœ… COMPLETED AND MERGED
   
   **Overview**: [what was implemented]
   **Quality**: Code review passed, tests passed, CI green
   **Impact**: [business value delivered]
   ```

### **STEP 6: Update Changelog with Merge Details**

#### **Update Existing Changelog Entry**
1. **Update the previously generated changelog** with merge information:
   - Add PR merge details: SHA [COMMIT_SHA], merged at [TIMESTAMP], PR URL [PR_URL]
   - Finalize the changelog entry with complete implementation and merge information

2. **Ensure changelog completeness**: Verify the entry includes both the feature details and merge metadata

### **STEP 7: Linear Updates**

1. **Post completion** using `mcp__linear__create_comment`:
   ```markdown
   ðŸŽ‰ Task completed and PR merged
   
   **Status**: âœ… COMPLETED
   **SHA**: [commit]
   **PR**: [URL]
   **Date**: [timestamp]
   **Archive**: `tasks/completed/task-[date]-[title]/`
   
   **Summary**: [functionality delivered]
   **Quality**: Review passed, tests green
   ```

2. **Update status** using `mcp__linear__update_issue`:
   - **state**: "Done"

### **STEP 8: Archiving**

1. **Move task directory**:
   ```bash
   mv tasks/task-YYYY-MM-DD-[title]/ tasks/completed/
   ```

2. **Verify structure**:
   ```
   tasks/completed/task-[date]-[title]/
   â”œâ”€â”€ [Task].md
   â”œâ”€â”€ Code Review - [Task].md
   â””â”€â”€ [other files]
   ```

3. **Clean up**: Verify active tasks clean, update indices if needed

### **STEP 9: Notification**

**Inform user**:
```markdown
âœ… Task completed and archived!

**Task**: [Title]
**PR**: [URL] - âœ… Merged
**Linear**: [URL] - âœ… Done
**Archived**: `tasks/completed/task-[date]-[title]/`
**SHA**: [commit]

**Summary**: [what was delivered]
**Quality**: Review approved, tests passed

Task lifecycle complete!
```

## ERROR HANDLING

**Merge Fails**: Check conflicts with `gh pr view`, notify user, provide resolution guidance

**Linear Fails**: Complete merge anyway, alert user, provide manual update info

**Archiving Fails**: Complete merge/Linear first, alert user, provide manual steps

## SUCCESS CRITERIA

- [ ] Pre-merge validation (approved, CI green, no conflicts)
- [ ] User confirmed merge approval
- [ ] Documentation and changelog updates committed to PR branch
- [ ] All agent-generated updates pushed to PR before merge
- [ ] PR merged with SHA documented
- [ ] Task status "Completed" with timestamp
- [ ] PR Traceability filled out
- [ ] Linear updated with completion status
- [ ] Task archived to `tasks/completed/`
- [ ] User notified with details

## QUALITY CHECKLIST

**Pre-Merge**: Review approved, CI green, no conflicts, user approval
**Post-Merge**: PR merged, changes in target branch, CI passing